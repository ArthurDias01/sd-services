{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/arthur/Documents/Projects/sd-services/src/app/api/image/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\n\nconst R2_HOST_RE = /^https:\\/\\/[a-zA-Z0-9.-]+\\.r2\\.dev(\\/|$)/;\nconst RELATIVE_RE = /^\\/(?!\\/)/;\n\nfunction isAllowedImageUrl(url: string): boolean {\n  try {\n    if (RELATIVE_RE.test(url)) return true;\n    const u = new URL(url);\n    if (u.protocol !== \"https:\") return false;\n    if (u.hostname === \"localhost\" || u.hostname.endsWith(\".vercel.app\"))\n      return true;\n    if (R2_HOST_RE.test(url)) return true;\n    const r2Public = process.env.R2_PUBLIC_URL;\n    if (r2Public) {\n      const base = new URL(r2Public);\n      if (u.origin === base.origin) return true;\n    }\n    return false;\n  } catch {\n    return false;\n  }\n}\n\nexport async function GET(request: Request) {\n  const { searchParams } = new URL(request.url);\n  const url = searchParams.get(\"url\");\n  if (!url || !isAllowedImageUrl(url)) {\n    return NextResponse.json({ error: \"Invalid or disallowed URL\" }, { status: 400 });\n  }\n\n  const resolved = url.startsWith(\"/\")\n    ? new URL(url, request.url).toString()\n    : url;\n\n  try {\n    const res = await fetch(resolved, {\n      headers: { Accept: \"image/*\" },\n      cache: \"force-cache\",\n    });\n    if (!res.ok) {\n      return NextResponse.json(\n        { error: \"Upstream image failed\" },\n        { status: res.status },\n      );\n    }\n    const contentType = res.headers.get(\"Content-Type\") ?? \"image/jpeg\";\n    const body = res.body;\n    if (!body) {\n      return NextResponse.json(\n        { error: \"No image body\" },\n        { status: 502 },\n      );\n    }\n    return new NextResponse(body, {\n      status: 200,\n      headers: {\n        \"Content-Type\": contentType,\n        \"Cache-Control\": \"public, max-age=31536000, immutable\",\n      },\n    });\n  } catch (err) {\n    console.error(\"[api/image]\", err);\n    return NextResponse.json(\n      { error: \"Failed to fetch image\" },\n      { status: 502 },\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,aAAa;AACnB,MAAM,cAAc;AAEpB,SAAS,kBAAkB,GAAW;IACpC,IAAI;QACF,IAAI,YAAY,IAAI,CAAC,MAAM,OAAO;QAClC,MAAM,IAAI,IAAI,IAAI;QAClB,IAAI,EAAE,QAAQ,KAAK,UAAU,OAAO;QACpC,IAAI,EAAE,QAAQ,KAAK,eAAe,EAAE,QAAQ,CAAC,QAAQ,CAAC,gBACpD,OAAO;QACT,IAAI,WAAW,IAAI,CAAC,MAAM,OAAO;QACjC,MAAM,WAAW,QAAQ,GAAG,CAAC,aAAa;QAC1C,IAAI,UAAU;YACZ,MAAM,OAAO,IAAI,IAAI;YACrB,IAAI,EAAE,MAAM,KAAK,KAAK,MAAM,EAAE,OAAO;QACvC;QACA,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe,IAAI,OAAgB;IACxC,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;IAC5C,MAAM,MAAM,aAAa,GAAG,CAAC;IAC7B,IAAI,CAAC,OAAO,CAAC,kBAAkB,MAAM;QACnC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA4B,GAAG;YAAE,QAAQ;QAAI;IACjF;IAEA,MAAM,WAAW,IAAI,UAAU,CAAC,OAC5B,IAAI,IAAI,KAAK,QAAQ,GAAG,EAAE,QAAQ,KAClC;IAEJ,IAAI;QACF,MAAM,MAAM,MAAM,MAAM,UAAU;YAChC,SAAS;gBAAE,QAAQ;YAAU;YAC7B,OAAO;QACT;QACA,IAAI,CAAC,IAAI,EAAE,EAAE;YACX,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAwB,GACjC;gBAAE,QAAQ,IAAI,MAAM;YAAC;QAEzB;QACA,MAAM,cAAc,IAAI,OAAO,CAAC,GAAG,CAAC,mBAAmB;QACvD,MAAM,OAAO,IAAI,IAAI;QACrB,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAgB,GACzB;gBAAE,QAAQ;YAAI;QAElB;QACA,OAAO,IAAI,gJAAY,CAAC,MAAM;YAC5B,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,iBAAiB;YACnB;QACF;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,eAAe;QAC7B,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}