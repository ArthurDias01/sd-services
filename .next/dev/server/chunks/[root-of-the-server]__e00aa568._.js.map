{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/arthur/Documents/Projects/sd-services/src/lib/auth-client.ts"],"sourcesContent":["import { createAuthClient } from \"better-auth/react\";\n\n/**\n * Always use same-origin for auth (no external server).\n * Explicit baseURL in the browser ensures the client never uses a cached or env-based old server URL.\n */\nexport const authClient = createAuthClient({\n  ...(typeof window !== \"undefined\" && { baseURL: window.location.origin }),\n});\n"],"names":[],"mappings":";;;;AAAA;;AAMO,MAAM,aAAa,IAAA,yMAAgB,EAAC;IACzC,GAAI,kDAAkB,eAAe;QAAE,SAAS,OAAO,QAAQ,CAAC,MAAM;IAAC,CAAC;AAC1E"}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/arthur/Documents/Projects/sd-services/src/lib/r2.ts"],"sourcesContent":["import { PutObjectCommand, S3Client } from \"@aws-sdk/client-s3\";\n\nfunction getR2Client(): S3Client | null {\n  const accountId = process.env.R2_ACCOUNT_ID;\n  const accessKeyId = process.env.R2_ACCESS_KEY_ID;\n  const secretAccessKey = process.env.R2_SECRET_ACCESS_KEY;\n\n  if (!accountId || !accessKeyId || !secretAccessKey) return null;\n\n  return new S3Client({\n    region: \"auto\",\n    // The S3-compatible API endpoint — used only for writes, never for public reads.\n    endpoint: `https://${accountId}.r2.cloudflarestorage.com`,\n    credentials: { accessKeyId, secretAccessKey },\n    // Force path-style so the SDK routes correctly: endpoint/{bucket}/{key}\n    forcePathStyle: true,\n  });\n}\n\nexport type UploadResult = { url: string };\n\n/**\n * Upload a file buffer to R2. Falls back to local /public/uploads when R2\n * env vars are not configured (development convenience).\n *\n * R2_PUBLIC_URL must be the **public** URL root for your bucket, e.g.:\n *   - https://pub-<hash>.r2.dev          (R2 managed public access)\n *   - https://images.yourdomain.com      (custom domain)\n *\n * Do NOT set it to the S3-compatible storage endpoint\n * (*.r2.cloudflarestorage.com) — that requires auth and browsers cannot\n * load images from it directly.\n */\nexport async function uploadFile(\n  file: File,\n  folder = \"uploads\",\n): Promise<UploadResult> {\n  const ext = file.name.includes(\".\")\n    ? file.name.split(\".\").pop()!.toLowerCase()\n    : \"bin\";\n  const key = `${folder}/${crypto.randomUUID()}.${ext}`;\n  const buffer = Buffer.from(await file.arrayBuffer());\n\n  const r2 = getR2Client();\n\n  if (r2) {\n    const bucket = process.env.R2_BUCKET_NAME;\n    const publicUrl = process.env.R2_PUBLIC_URL;\n\n    if (!bucket || !publicUrl) {\n      throw new Error(\n        \"R2_BUCKET_NAME and R2_PUBLIC_URL must be set when using R2\",\n      );\n    }\n\n    // Guard against accidentally using the private API endpoint as the public URL\n    if (publicUrl.includes(\"r2.cloudflarestorage.com\")) {\n      throw new Error(\n        \"R2_PUBLIC_URL must be your bucket's public URL (pub-xxx.r2.dev or custom domain), \" +\n          \"not the S3-compatible API endpoint (*.r2.cloudflarestorage.com). \" +\n          \"Enable public access in your R2 bucket settings to get the public URL.\",\n      );\n    }\n\n    await r2.send(\n      new PutObjectCommand({\n        Bucket: bucket,\n        Key: key,\n        Body: buffer,\n        ContentType: file.type || \"application/octet-stream\",\n        ContentLength: buffer.byteLength,\n      }),\n    );\n\n    const base = publicUrl.replace(/\\/$/, \"\");\n    return { url: `${base}/${key}` };\n  }\n\n  // Local fallback — save to public/uploads/\n  const { writeFile, mkdir } = await import(\"node:fs/promises\");\n  const nodePath = await import(\"node:path\");\n  const uploadDir = nodePath.join(process.cwd(), \"public\", \"uploads\");\n  await mkdir(uploadDir, { recursive: true });\n  const fileName = `${crypto.randomUUID()}.${ext}`;\n  await writeFile(nodePath.join(uploadDir, fileName), buffer);\n  return { url: `/uploads/${fileName}` };\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,SAAS;IACP,MAAM,YAAY,QAAQ,GAAG,CAAC,aAAa;IAC3C,MAAM,cAAc,QAAQ,GAAG,CAAC,gBAAgB;IAChD,MAAM,kBAAkB,QAAQ,GAAG,CAAC,oBAAoB;IAExD,IAAI,CAAC,aAAa,CAAC,eAAe,CAAC,iBAAiB,OAAO;IAE3D,OAAO,IAAI,gOAAQ,CAAC;QAClB,QAAQ;QACR,iFAAiF;QACjF,UAAU,CAAC,QAAQ,EAAE,UAAU,yBAAyB,CAAC;QACzD,aAAa;YAAE;YAAa;QAAgB;QAC5C,wEAAwE;QACxE,gBAAgB;IAClB;AACF;AAgBO,eAAe,WACpB,IAAU,EACV,SAAS,SAAS;IAElB,MAAM,MAAM,KAAK,IAAI,CAAC,QAAQ,CAAC,OAC3B,KAAK,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,GAAI,WAAW,KACvC;IACJ,MAAM,MAAM,GAAG,OAAO,CAAC,EAAE,OAAO,UAAU,GAAG,CAAC,EAAE,KAAK;IACrD,MAAM,SAAS,OAAO,IAAI,CAAC,MAAM,KAAK,WAAW;IAEjD,MAAM,KAAK;IAEX,IAAI,IAAI;QACN,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc;QACzC,MAAM,YAAY,QAAQ,GAAG,CAAC,aAAa;QAE3C,IAAI,CAAC,UAAU,CAAC,WAAW;YACzB,MAAM,IAAI,MACR;QAEJ;QAEA,8EAA8E;QAC9E,IAAI,UAAU,QAAQ,CAAC,6BAA6B;YAClD,MAAM,IAAI,MACR,uFACE,sEACA;QAEN;QAEA,MAAM,GAAG,IAAI,CACX,IAAI,wOAAgB,CAAC;YACnB,QAAQ;YACR,KAAK;YACL,MAAM;YACN,aAAa,KAAK,IAAI,IAAI;YAC1B,eAAe,OAAO,UAAU;QAClC;QAGF,MAAM,OAAO,UAAU,OAAO,CAAC,OAAO;QACtC,OAAO;YAAE,KAAK,GAAG,KAAK,CAAC,EAAE,KAAK;QAAC;IACjC;IAEA,2CAA2C;IAC3C,MAAM,EAAE,SAAS,EAAE,KAAK,EAAE,GAAG;IAC7B,MAAM,WAAW;IACjB,MAAM,YAAY,SAAS,IAAI,CAAC,QAAQ,GAAG,IAAI,UAAU;IACzD,MAAM,MAAM,WAAW;QAAE,WAAW;IAAK;IACzC,MAAM,WAAW,GAAG,OAAO,UAAU,GAAG,CAAC,EAAE,KAAK;IAChD,MAAM,UAAU,SAAS,IAAI,CAAC,WAAW,WAAW;IACpD,OAAO;QAAE,KAAK,CAAC,SAAS,EAAE,UAAU;IAAC;AACvC"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///Users/arthur/Documents/Projects/sd-services/src/app/api/upload/route.ts"],"sourcesContent":["import { headers } from \"next/headers\";\nimport { NextResponse } from \"next/server\";\n\nimport { authClient } from \"@/lib/auth-client\";\nimport { uploadFile } from \"@/lib/r2\";\n\nasync function getAdminSession() {\n  type SessionData = { user?: { email?: string | null } } | null;\n  let session: SessionData = null;\n  try {\n    const result = await authClient.getSession({\n      fetchOptions: { headers: await headers(), throw: false },\n    });\n    session =\n      result && typeof result === \"object\" && \"data\" in result\n        ? (result as { data: SessionData }).data\n        : null;\n  } catch {\n    return null;\n  }\n\n  if (!session?.user) return null;\n\n  const allowed = process.env.CMS_ALLOWED_EMAILS;\n  if (allowed) {\n    const emails = allowed.split(\",\").map((e) => e.trim().toLowerCase());\n    if (!emails.includes(session.user.email?.toLowerCase() ?? \"\")) return null;\n  }\n\n  return session;\n}\n\nexport async function POST(request: Request) {\n  const session = await getAdminSession();\n  if (!session) {\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n  }\n\n  let formData: FormData;\n  try {\n    formData = await request.formData();\n  } catch {\n    return NextResponse.json({ error: \"Invalid form data\" }, { status: 400 });\n  }\n\n  // Accept either a single \"file\" or multiple \"files[]\"\n  const rawFiles = formData.getAll(\"files\");\n  const single = formData.get(\"file\");\n  const allFiles: File[] = [\n    ...(rawFiles.filter((f) => f instanceof File) as File[]),\n    ...(single instanceof File ? [single] : []),\n  ];\n\n  if (allFiles.length === 0) {\n    return NextResponse.json({ error: \"No files provided\" }, { status: 400 });\n  }\n\n  try {\n    const results = await Promise.all(\n      allFiles.map((file) => uploadFile(file, \"uploads\")),\n    );\n    // Single file → { url } for backwards compat; multiple → { urls }\n    if (allFiles.length === 1) {\n      return NextResponse.json({ url: results[0]!.url, urls: [results[0]!.url] });\n    }\n    return NextResponse.json({ urls: results.map((r) => r.url) });\n  } catch (err) {\n    console.error(\"Upload error:\", err);\n    return NextResponse.json({ error: \"Upload failed\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AAEA;AACA;;;;;AAEA,eAAe;IAEb,IAAI,UAAuB;IAC3B,IAAI;QACF,MAAM,SAAS,MAAM,4IAAU,CAAC,UAAU,CAAC;YACzC,cAAc;gBAAE,SAAS,MAAM,IAAA,4IAAO;gBAAI,OAAO;YAAM;QACzD;QACA,UACE,UAAU,OAAO,WAAW,YAAY,UAAU,SAC9C,AAAC,OAAiC,IAAI,GACtC;IACR,EAAE,OAAM;QACN,OAAO;IACT;IAEA,IAAI,CAAC,SAAS,MAAM,OAAO;IAE3B,MAAM,UAAU,QAAQ,GAAG,CAAC,kBAAkB;IAC9C,IAAI,SAAS;QACX,MAAM,SAAS,QAAQ,KAAK,CAAC,KAAK,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI,GAAG,WAAW;QACjE,IAAI,CAAC,OAAO,QAAQ,CAAC,QAAQ,IAAI,CAAC,KAAK,EAAE,iBAAiB,KAAK,OAAO;IACxE;IAEA,OAAO;AACT;AAEO,eAAe,KAAK,OAAgB;IACzC,MAAM,UAAU,MAAM;IACtB,IAAI,CAAC,SAAS;QACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;IAEA,IAAI;IACJ,IAAI;QACF,WAAW,MAAM,QAAQ,QAAQ;IACnC,EAAE,OAAM;QACN,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAoB,GAAG;YAAE,QAAQ;QAAI;IACzE;IAEA,sDAAsD;IACtD,MAAM,WAAW,SAAS,MAAM,CAAC;IACjC,MAAM,SAAS,SAAS,GAAG,CAAC;IAC5B,MAAM,WAAmB;WACnB,SAAS,MAAM,CAAC,CAAC,IAAM,aAAa;WACpC,kBAAkB,OAAO;YAAC;SAAO,GAAG,EAAE;KAC3C;IAED,IAAI,SAAS,MAAM,KAAK,GAAG;QACzB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAoB,GAAG;YAAE,QAAQ;QAAI;IACzE;IAEA,IAAI;QACF,MAAM,UAAU,MAAM,QAAQ,GAAG,CAC/B,SAAS,GAAG,CAAC,CAAC,OAAS,IAAA,gIAAU,EAAC,MAAM;QAE1C,kEAAkE;QAClE,IAAI,SAAS,MAAM,KAAK,GAAG;YACzB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,KAAK,OAAO,CAAC,EAAE,CAAE,GAAG;gBAAE,MAAM;oBAAC,OAAO,CAAC,EAAE,CAAE,GAAG;iBAAC;YAAC;QAC3E;QACA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,MAAM,QAAQ,GAAG,CAAC,CAAC,IAAM,EAAE,GAAG;QAAE;IAC7D,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,iBAAiB;QAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAgB,GAAG;YAAE,QAAQ;QAAI;IACrE;AACF"}}]
}